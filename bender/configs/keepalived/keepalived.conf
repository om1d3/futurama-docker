# ============================================
# bender keepalived configuration
# role: MASTER (primary pihole)
# ============================================
# pihole high availability using vrrp
# bender: MASTER priority 150
# amy: BACKUP priority 100
# vip: 192.168.21.100 (shared dns address)
# ============================================

vrrp_script chk_pihole {
    script "wget -q --spider --timeout=2 http://127.0.0.1:8053/admin/"
    interval 5
    weight -20
    fall 3
    rise 2
}

vrrp_instance VI_PIHOLE {
    state MASTER
    interface br0
    virtual_router_id 51
    priority 150
    advert_int 1
    
    authentication {
        auth_type PASS
        auth_pass piholeha
    }
    
    virtual_ipaddress {
        192.168.21.100/24 dev br0
    }
    
    track_script {
        chk_pihole
    }
    
    notify_master "/bin/echo 'bender became MASTER' | logger -t keepalived"
    notify_backup "/bin/echo 'bender became BACKUP' | logger -t keepalived"
    notify_fault  "/bin/echo 'bender entered FAULT' | logger -t keepalived"
}

# ============================================
# configuration notes
# ============================================
#
# interface: br0
#   - TrueNAS Scale uses br0 as the default bridge interface
#   - verify with: ip addr show
#   - if different, update interface name above
#
# priority: 150
#   - higher than amy (100), so bender is preferred master
#   - when pihole fails, priority drops by 20 (to 130)
#   - if pihole fails completely, amy takes over
#
# health check: wget to pihole admin
#   - checks port 8053 (pihole web ui mapped from 80)
#   - timeout: 2 seconds
#   - check interval: 5 seconds
#   - requires 3 failures to mark down
#   - requires 2 successes to mark up
#
# authentication:
#   - simple password auth between vrrp peers
#   - must match on both bender and amy
#
# virtual_router_id: 51
#   - must be same on both peers
#   - unique per vrrp instance on network
#
# ============================================
# troubleshooting commands
# ============================================
#
# check vip assignment:
#   ip addr show | grep 192.168.21.100
#
# check keepalived logs:
#   docker logs keepalived 2>&1 | grep -E "Script|succeeded|failed"
#
# test health check manually:
#   docker exec keepalived wget -q --spider --timeout=2 http://127.0.0.1:8053/admin/
#   echo "exit code: $?"
#
# force failover test (on bender):
#   docker stop pihole
#   sleep 10
#   dig @192.168.21.100 google.com
#   docker start pihole
# ============================================
