! ============================================
! keepalived configuration for amy (backup)
! version: 85
! ============================================
! pihole high availability configuration
! 
! role: backup (secondary dns server)
! partner: bender (master)
! vip: 192.168.21.100
!
! failover logic:
!   - normal: bender (priority 200) holds vip
!   - if bender's pihole fails: priority drops to 50 (200-150)
!   - amy (priority 100) takes over vip
!   - when bender recovers: vip returns to bender
!
! health check:
!   - checks pihole web interface every 2 seconds
!   - 3 consecutive failures = script failed
!   - 2 consecutive successes = script recovered
!   - weight -150 means: if script fails, priority = 100-150 = -50
! ============================================

global_defs {
    router_id PIHOLE_AMY
}

vrrp_script chk_pihole {
    script "/bin/sh -c '/usr/bin/wget -q --spider --timeout=2 http://127.0.0.1:8053/admin/'"
    interval 2
    weight -150
    fall 3
    rise 2
}

vrrp_instance PIHOLE_VIP {
    state BACKUP
    interface enp4s0
    virtual_router_id 53
    priority 100
    advert_int 1
    
    authentication {
        auth_type PASS
        auth_pass pihole53
    }
    
    unicast_src_ip 192.168.21.130
    unicast_peer {
        192.168.21.121
    }
    
    virtual_ipaddress {
        192.168.21.100/24 dev enp4s0
    }
    
    track_script {
        chk_pihole
    }
}

! ============================================
! troubleshooting commands:
! ============================================
! check vip assignment:
!   ip addr | grep 192.168.21.100
!
! check keepalived logs:
!   docker logs keepalived 2>&1 | tail -30
!
! check health script status:
!   docker logs keepalived 2>&1 | grep -E "Script|succeeded|failed"
!
! test health check manually:
!   docker exec keepalived wget -q --spider --timeout=2 http://127.0.0.1:8053/admin/
!   echo "exit code: $?"
!
! force failover test (on bender):
!   docker stop pihole
!   sleep 10
!   dig @192.168.21.100 google.com
!   docker start pihole
! ============================================
